Testing Master:
  type: test
  tags:
    - master-selenium
  only:
    - master
  script:
    - git clone -b develop http://jenkins:$Env:JENKINS_PASS@192.168.0.222/ION/ion-portal.git 
    - cmd /c mklink /D $Env:PJ_BASE\node_modules "$Env:RUNNER_PATH\node_modules"
    - cd .\$Env:PJ_BASE
    - bin\ionpm install $Env:PJ@$Env:CI_BUILD_REF --tag $Env:CI_BUILD_REF_NAME --token $Env:JENKINS_TOKEN
    - gulp build
    - start-job -ScriptBlock {node bin/www} -InitializationScript {cd "$Env:RUNNER_PATH\$Env:CI_PROJECT_DIR\$Env:PJ_BASE"} -Name $Env:PJ_DOCKER_NAME_MASTER
    - npm test
"http://docker.local:8030":
  type: deploy
  tags:
    - docker
  only:
    - master
  script:
    - sudo docker stop $PJ_DOCKER_NAME_MASTER
    - cp -R ../../$BASE_GROUP/$PJ_BASE ./
    - cd $PJ_BASE
    - node bin/ionpm.js install $PJ@$CI_BUILD_REF --tag $CI_BUILD_REF_NAME --token $JENKINS_TOKEN
    - export $PJ_BUILD_VAR=$PJ_DOCKER_NAME_MASTER
    - gulp build
    - gulp distr
    - cd distr
    - sudo docker cp ./ $PJ_DOCKER_NAME_MASTER:/var/www
    - sudo docker start $PJ_DOCKER_NAME_MASTER
    - sleep 10
    - sudo docker exec $PJ_DOCKER_NAME_MASTER node /var/www/bin/init-db
    - sleep 2
    - sudo docker restart $PJ_DOCKER_NAME_MASTER
Testing Dev:
  type: test
  tags:
    - dev-selenium
  only:
    - develop
  script:
    - git clone -b develop http://jenkins:$Env:JENKINS_PASS@192.168.0.222/ION/ion-portal.git 
    - cmd /c mklink /D $Env:PJ_BASE\node_modules "$Env:RUNNER_PATH\node_modules"
    - cd .\$Env:PJ_BASE
    - bin\ionpm install $Env:PJ@$Env:CI_BUILD_REF --tag $Env:CI_BUILD_REF_NAME --token $Env:JENKINS_TOKEN
    - gulp build
    - start-job -ScriptBlock {node bin/www} -InitializationScript {cd "$Env:RUNNER_PATH\$Env:CI_PROJECT_DIR\$Env:PJ_BASE"} -Name $Env:PJ_DOCKER_NAME_DEV
    - npm test
"http://docker.local:3030":
  type: deploy
  tags:
    - dev-docker
  only:
    - develop
  script:
    - sudo docker stop $PJ_DOCKER_NAME_DEV
    - cp -R ../../$BASE_GROUP/$PJ_BASE ./
    - cd $PJ_BASE
    - node bin/ionpm.js install $PJ@$CI_BUILD_REF --tag $CI_BUILD_REF_NAME --token $JENKINS_TOKEN
    - export $PJ_BUILD_VAR=$PJ_BUILD_VAR_KEY
    - gulp build
    - gulp distr
    - cd distr
    - sudo docker cp ./ $PJ_DOCKER_NAME_DEV:/var/www
    - sudo docker start $PJ_DOCKER_NAME_DEV
    - sleep 10
    - sudo docker exec $PJ_DOCKER_NAME_DEV node /var/www/bin/init-db
    - sleep 2
    - sudo docker restart $PJ_DOCKER_NAME_DEV